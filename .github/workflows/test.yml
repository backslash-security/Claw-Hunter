name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-bash:
    name: Bash Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install jq (for JSON validation)
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y jq
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install jq
          fi
        shell: bash
      
      - name: Make scripts executable
        run: |
          chmod +x claw-hunter.sh
          chmod +x tests/bash/run-tests.sh
        
      - name: Run Bash tests
        run: |
          cd tests/bash
          ./run-tests.sh
        shell: bash
      
      - name: Run smoke test
        run: |
          # Run script - accept exit codes 0, 1, or 2 (0=clean, 1=issues, 2=not installed)
          ./claw-hunter.sh --json-path /tmp/smoke-test.json || EXIT_CODE=$?
          
          if [ -f /tmp/smoke-test.json ]; then
            echo "✓ Smoke test passed - JSON file created"
            # Validate JSON is well-formed
            if jq . /tmp/smoke-test.json > /dev/null 2>&1; then
              echo "✓ JSON is valid"
            else
              echo "✗ JSON is invalid"
              exit 1
            fi
          else
            echo "✗ Smoke test failed - no JSON file created"
            exit 1
          fi
          
          # Exit code 2 is OK (OpenClaw not installed in test environment)
          if [ "${EXIT_CODE:-0}" -eq 0 ] || [ "${EXIT_CODE:-0}" -eq 1 ] || [ "${EXIT_CODE:-0}" -eq 2 ]; then
            echo "✓ Script exit code is valid: ${EXIT_CODE:-0}"
            exit 0
          else
            echo "✗ Unexpected exit code: ${EXIT_CODE:-0}"
            exit 1
          fi
        shell: bash

  test-powershell:
    name: PowerShell Tests
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run PowerShell tests
        shell: powershell
        run: |
          cd tests/powershell
          .\run-tests.ps1
      
      - name: Run smoke test
        shell: powershell
        run: |
          # Run script - accept exit codes 0, 1, or 2 (0=clean, 1=issues, 2=not installed)
          $exitCode = 0
          try {
            .\claw-hunter.ps1 --json-path "$env:TEMP\smoke-test.json"
          } catch {
            $exitCode = $LASTEXITCODE
          }
          
          if (Test-Path "$env:TEMP\smoke-test.json") {
            Write-Host "✓ Smoke test passed - JSON file created" -ForegroundColor Green
            
            # Validate JSON is well-formed
            try {
              $json = Get-Content "$env:TEMP\smoke-test.json" | ConvertFrom-Json
              Write-Host "✓ JSON is valid" -ForegroundColor Green
            } catch {
              Write-Host "✗ JSON is invalid" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "✗ Smoke test failed - no JSON file created" -ForegroundColor Red
            exit 1
          }
          
          # Exit code 2 is OK (OpenClaw not installed in test environment)
          if ($exitCode -eq 0 -or $exitCode -eq 1 -or $exitCode -eq 2) {
            Write-Host "✓ Script exit code is valid: $exitCode" -ForegroundColor Green
            exit 0
          } else {
            Write-Host "✗ Unexpected exit code: $exitCode" -ForegroundColor Red
            exit 1
          }

  lint-bash:
    name: Bash Linting (shellcheck)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Run shellcheck
        run: shellcheck claw-hunter.sh || true
        # Set to || true for now, can make strict later

  lint-powershell:
    name: PowerShell Linting (PSScriptAnalyzer)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install PSScriptAnalyzer
        shell: powershell
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
      
      - name: Run PSScriptAnalyzer
        shell: powershell
        run: |
          $results = Invoke-ScriptAnalyzer -Path .\claw-hunter.ps1 -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Host "⚠️ PSScriptAnalyzer found issues" -ForegroundColor Yellow
          } else {
            Write-Host "✓ PSScriptAnalyzer passed" -ForegroundColor Green
          }
