name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-bash:
    name: Bash Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install jq (for JSON validation)
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y jq
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install jq
          fi
        shell: bash
      
      - name: Make scripts executable
        run: |
          chmod +x claw-hunter.sh
          chmod +x tests/bash/run-tests.sh
        
      - name: Run Bash tests
        run: |
          cd tests/bash
          ./run-tests.sh
        shell: bash
      
      - name: Run smoke test
        run: |
          # Run script - should exit 0 for success
          ./claw-hunter.sh --json-path /tmp/smoke-test.json || EXIT_CODE=$?
          
          if [ -f /tmp/smoke-test.json ]; then
            echo "✓ Smoke test passed - JSON file created"
            # Validate JSON is well-formed
            if jq . /tmp/smoke-test.json > /dev/null 2>&1; then
              echo "✓ JSON is valid"
            else
              echo "✗ JSON is invalid"
              exit 1
            fi
          else
            echo "✗ Smoke test failed - no JSON file created"
            exit 1
          fi
          
          # Script should exit 0 for success
          if [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo "✓ Script exit code is valid: ${EXIT_CODE:-0}"
            exit 0
          else
            echo "✗ Unexpected exit code: ${EXIT_CODE:-0}"
            exit 1
          fi
        shell: bash
      
      - name: Test HTTP upload functionality
        run: |
          # Run script WITH --upload-url to test the actual upload feature
          ./claw-hunter.sh --json-path /tmp/upload-test.json --upload-url "https://httpbin.org/post" --log-file /tmp/upload-log.txt >/dev/null 2>&1 || EXIT_CODE=$?
          
          # Check if JSON file was created
          if [ ! -f /tmp/upload-test.json ]; then
            echo "✗ HTTP upload test failed - no JSON file created"
            cat /tmp/upload-log.txt 2>/dev/null || true
            exit 1
          fi
          
          # Check if script reported upload success
          if grep -q "Upload successful" /tmp/upload-log.txt 2>/dev/null; then
            echo "✓ HTTP upload successful - script uploaded via --upload-url"
            
            # Validate JSON file contains expected data
            if grep -q '"platform"' /tmp/upload-test.json; then
              echo "✓ JSON file validated - contains expected platform field"
              exit 0
            else
              echo "✗ JSON file invalid - missing platform field"
              exit 1
            fi
          else
            # Check if script ran successfully
            if [ "${EXIT_CODE:-0}" -eq 0 ]; then
              echo "⚠ HTTP upload test passed with warnings (exit code: ${EXIT_CODE:-0})"
              exit 0
            else
              echo "✗ HTTP upload failed - no success message in logs"
              cat /tmp/upload-log.txt 2>/dev/null || true
              exit 1
            fi
          fi
          
          # Clean up
          rm -f /tmp/upload-test.json /tmp/upload-log.txt
        shell: bash

  test-powershell:
    name: PowerShell Tests
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run PowerShell tests
        shell: powershell
        run: |
          cd tests/powershell
          .\run-tests.ps1
      
      - name: Run smoke test
        shell: powershell
        run: |
          # Run script - should exit 0 for success
          $ErrorActionPreference = "Continue"
          .\claw-hunter.ps1 --json-path "$env:TEMP\smoke-test.json"
          $exitCode = $LASTEXITCODE
          
          if (Test-Path "$env:TEMP\smoke-test.json") {
            Write-Host "[PASS] Smoke test passed - JSON file created" -ForegroundColor Green
            
            # Validate JSON is well-formed
            try {
              $json = Get-Content "$env:TEMP\smoke-test.json" -Raw | ConvertFrom-Json
              Write-Host "[PASS] JSON is valid" -ForegroundColor Green
            } catch {
              Write-Host "[FAIL] JSON is invalid" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "[FAIL] Smoke test failed - no JSON file created" -ForegroundColor Red
            exit 1
          }
          
          # Script should exit 0 for success
          if ($exitCode -eq 0) {
            Write-Host "[PASS] Script exit code is valid: $exitCode" -ForegroundColor Green
            exit 0
          } else {
            Write-Host "[FAIL] Unexpected exit code: $exitCode" -ForegroundColor Red
            exit 1
          }
      
      - name: Test HTTP upload functionality
        shell: powershell
        run: |
          # Run script WITH --upload-url and --log-file to test the actual upload feature
          $ErrorActionPreference = "Continue"
          $logFile = "$env:TEMP\upload-log.txt"
          $output = .\claw-hunter.ps1 --json-path "$env:TEMP\upload-test.json" --upload-url "https://httpbin.org/post" --log-file $logFile 2>&1 | Out-String
          $exitCode = $LASTEXITCODE
          
          # Check if JSON file was created
          if (-not (Test-Path "$env:TEMP\upload-test.json")) {
            Write-Host "[FAIL] HTTP upload test failed - no JSON file created" -ForegroundColor Red
            if (Test-Path $logFile) { Get-Content $logFile }
            exit 1
          }
          
          # Check if script reported upload success in log file
          if ((Test-Path $logFile) -and (Select-String -Path $logFile -Pattern "Upload successful" -Quiet)) {
            Write-Host "[PASS] HTTP upload successful - script uploaded via --upload-url" -ForegroundColor Green
            
            # Validate JSON file contains expected data
            $content = Get-Content -Path "$env:TEMP\upload-test.json" -Raw
            if ($content -match '"platform"') {
              Write-Host "[PASS] JSON file validated - contains expected platform field" -ForegroundColor Green
              exit 0
            } else {
              Write-Host "[FAIL] JSON file invalid - missing platform field" -ForegroundColor Red
              exit 1
            }
          } else {
            # Check if script ran successfully
            if ($exitCode -eq 0) {
              Write-Host "[WARN] HTTP upload test passed with warnings (exit code: $exitCode)" -ForegroundColor Yellow
              exit 0
            } else {
              Write-Host "[FAIL] HTTP upload failed - no success message in logs" -ForegroundColor Red
              if (Test-Path $logFile) { Get-Content $logFile }
              exit 1
            }
          }
          
          # Clean up
          Remove-Item -Path "$env:TEMP\upload-test.json" -ErrorAction SilentlyContinue
          Remove-Item -Path $logFile -ErrorAction SilentlyContinue

  lint-bash:
    name: Bash Linting (shellcheck)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Run shellcheck
        run: shellcheck claw-hunter.sh || true
        # Set to || true for now, can make strict later

  lint-powershell:
    name: PowerShell Linting (PSScriptAnalyzer)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install PSScriptAnalyzer
        shell: powershell
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
      
      - name: Run PSScriptAnalyzer
        shell: powershell
        run: |
          $results = Invoke-ScriptAnalyzer -Path .\claw-hunter.ps1 -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Host "[WARN] PSScriptAnalyzer found issues" -ForegroundColor Yellow
          } else {
            Write-Host "[PASS] PSScriptAnalyzer passed" -ForegroundColor Green
          }
